# 一、关于网络协议

## 1、TCP和UDP二者的区别是什么？

 我喜欢比较两事物的不同点，这不仅使他们更加容易比较，而且会更容易记住他们之间的差异。当我们比较TCP，UDP，我们需要了解TCP和UDP各自的工作方式，了解哪种协议提供了可靠保证交付和而哪个又没有。哪种协议是快速的，他为什么更加快速，最重要的是，当我们了解了这些，在建设我们自己的分布式应用程序时，就知道该选择TCP还是 UDP。在这篇文章中，我们将看到9点UDP和TCP之间的差异，例如，连接步骤，排序，速度，可靠性，开销，头大小，拥塞控制，应用以及基于TCP和UDP协议不同，他们如何传输数据。



### 1. 基于连接vs无连接

他们之间的第一点并且最重要的区别是：TCP是面向连接的协议，而UDP是无连接的协议。这意味着当一个客户端和一个服务器通过TCP发送数据之前，必须先建立连接，他们可以通过TCP发送数据。建立连接的过程也被称为TCP握手，他通过控制消息在客户端和服务器之间互换来实现。下面的图形象描述了TCP握手过程。客户端，它也是TCP连接的发起者，发送一个SYN消息给服务器，该服务器端正在监听某个TCP端口。服务器接收该消息并发送一个SYN-ACK消息，客户端接受到该消息之后会再回一个ACK消息。一旦服务器收到ACK消息，TCP连接就建立成功，准备数据传输了。另一方面，UDP是无连接的协议，和点对点连接之前不需要发送消息。这就是为什么，UDP更加适合消息的[多播发布](http://javarevisited.blogspot.sg/2010/10/common-terms-used-in-tibco-rv.html)，从单个点向多个点传输消息。



![img](https://img-blog.csdn.net/20160321115232147)

图1：TCP消息握手(TCP - Handshake Message)



### 2. 可靠性 不同

TCP提供交付保证,这意味着一个使用TCP协议发送的消息是保证交付给客户端的。如果消息在传输过程中丢失,那么它将重发,这是由TCP协议本身控制的。另一方面,UDP是不可靠的,它不提供任何交付的保证。一个数据报包在运输途中可能会丢失。这就是为什么UDP是不适合保证交付的项目。

 

### 3.有序性

除了提供交付保证，为TCP也保证了消息的有序性。该消息将以从服务器端发出的同样的顺序发送到客户端，尽管这些消息到网络的另一端时可能是无序的。TCP协议将会为你排好序。UDP不提供任何有序性或序列性的保证。数据包将以任何可能的顺序到达。这就是为什么TCP是适合需要顺序交付方式的应用，尽管有基于UDP的协议通过使用序列号和重传来提供有序和可靠性的应用，如[TIBCO Rendezvous](http://javarevisited.blogspot.sg/2010/10/tibco-rv-messagging.html)，他实际上就是一个基于UDP的应用。

 

### 4.数据边界

TCP不保存数据的边界，而UDP保证。在传输控制协议，数据以字节流的形式发送，并没有明显的标志表明传输信号消息（段）的边界。在UDP中，数据包单独发送的，只有当他们到达时，才会再次集成。包有明确的界限来哪些包已经收到，这意味着在消息发送后，在接收器接口将会有一个读操作，来生成一个完整的消息。虽然TCP也将在收集所有字节之后生成一个完整的消息，但是这些信息在传给传输给接受端之前将储存在TCP缓冲区，以确保更好的使用网络带宽

 

### 5.速度

总而言之，TCP速度比较慢，而UDP速度比较快，因为TCP必须创建连接，以保证消息的可靠交付和有序性，他需要做比UDP多的多的事。这就是为什么UDP更适用于对速度比较敏感的应用，例如：在线视频媒体，电视广播和多人在线游戏。

 

### 6.重量级vs轻量级

由于上述的开销，TCP被认为是重量级的协议，而与之相比，UDP协议则是一个轻量级的协议。因为UDP传输的信息中不承担任何间接创造连接，保证交货或秩序的的信息。这也反映在用于承载元数据的头的大小。

 

### 7. 头大小

TCP具有比UDP更大的头。一个TCP数据包报头的大小是20字节，UDP数据报报头是8个字节。TCP报头中包含序列号，ACK号，数据偏移量，保留，控制位，窗口，紧急指针，可选项，填充项，校验位，源端口和目的端口。而UDP报头只包含长度，源端口号，目的端口，和校验和。下图是TCP和UDP头：



![img](https://img-blog.csdn.net/20160321115320061)

图2：TCP包格式(TCP Packet Format)



![img](https://img-blog.csdn.net/20160321115425437)

图3：UDP包格式(UDP Packet format)



### 8. 拥塞或流控制

TCP有流量控制。在任何用户数据可以被发送之前，TCP需要三数据包来设置一个套接字连接。TCP处理的可靠性和拥塞控制。另一方面，UDP不能进行流量控制。

 

### 9. 用法和应用

在互联网中，TCP和UDP都运行在哪些环境中了？在了解了TCP和UDP之间的关键差异之后，我们可以很容易地得出结论，哪种情况适合他们。由于TCP提供可靠交付和有序性的保证，它是最适合需要高可靠并且对传输时间要求不高的应用。UDP是更适合的应用程序需要快速，高效的传输的应用，如游戏。UDP是无状态的性质，在服务器端需要对大量客户端产生的少量请求进行应答的应用中是非常有用的。在实践中，TCP被用于金融领域，如FIX协议是一种基于TCP的协议，而UDP是大量使用在游戏和娱乐场所。

 

## 基于TCP和UDP的协议



基于TCP协议的最好例子是HTTP协议和HTTPS协议，他们几乎存在于互联网的任何地方，实际上，绝大多数你所熟悉的通常协议，都是基于TCP的，例如：Telnet，FTP以及SMTP协议。UDP协议没有TCP协议那么受欢迎，但是也被广泛应用，比如DHCP以及DNS协议，其他还有一些基于UDP的协议如SNMP,TFTP,BOOTP以及NFS（早期版本）。

特别需要记住的是，TCP是面向连接的，可靠的，缓慢的，可靠交付以及保证消息顺序的，而UDP是无连接的，不可靠的，没有序列保证，但是一个快速传输的协议。TCP头开销也比UDP高得多，因为它每个数据包中药发送更多的元数据。值得一提的是，TCP头的大小是20个字节，而UDP头大小是8个字节。如果你不想丢失任何消息，使用TCP协议，而UDP能够高速传输数据，并且丢失少量的数据包是可以接受的，如视频流或在线多玩家游戏。对于基于TCP / UDP协议，运行在Linux上的应用，需要牢记的[基本网络命令](http://javarevisited.blogspot.sg/2010/10/basic-networking-commands-in-linuxunix.html)，如Telnet和netstat，他们极大的帮助调试和排除任何连接问题。

## 2、常见的基于TCP/IP协议之上的应用层协议有哪些？

1. SMTP：简单邮件传输协议
2. Telnet：远程登录协议
3. SNMP：简单网络管理协议
4. FTP：文件传输协议
5. LPD：行式打印机守护进程
6. TFTP：简单文件传输协议
7. NFS：网络文件系统协议

## 3、如果做普通直播、互动直播和强互动的直播（比如网红直播打赏），你分别希望用那种协议？UDP还是TCP？为什么？

答：

映客、斗鱼这类娱乐直播与在线教育、音视频会议直播有着非常大的区别。在线教育、音视频会议这类直播属于**实时互动直播**，主要考虑**传输的实时性**，因此一般使用 **UDP** 作为底层传输协议；而娱乐直播对实时性要求不高，更多关注的是画面的质量、音视频是否卡顿等问题，所以一般采用 **TCP** 作为传输协议。我们称前者为实时互动直播，后者为传统直播。

现在让我告诉你正确答案：**必须使用 UDP，必须使用 UDP，必须使用 UDP**，重要的事情说三遍。

为什么一定要使用 UDP 呢？关于这个问题，你可以反向思考下，假如使用 TCP 会怎样呢？在极端网络情况下，TCP 为了传输的可靠性，它是如何做的呢？简单总结起来就是**“发送 -> 确认；超时 -> 重发”的反复过程**。

举个例子，A 与 B 通讯，A 首先向 B 发送数据，并启动一个**定时器**。当 B 收到 A 的数据后，B 需要给 A 回一个**ACK（确认）**消息，反复这样操作，数据就源源不断地从 A 流向了 B。如果因为某些原因，A 一直收不到 B 的确认消息会怎么办呢？当 A 的定时器超时后，A 将重发之前没有被确认的消息，并重新设置定时器。

在 TCP 协议中，为了避免重传次数过多，定时器的超时时间会按 **2 的指数增长**。也就是说，假设第一次设置的超时时间是 1 秒，那么第二次就是 2 秒，第三次是 4 秒……第七次是 64 秒。**如果第七次之后仍然超时，则断开 TCP 连接**。你可以计算一下，从第一次超时，到最后断开连接，这之间一共经历了 2 分 07 秒，是不是很恐怖？

如果遇到前面的情况，A 与 B 之间的连接断了，那还算是个不错的情况，因为还可以再重新建立连接。但如果在第七次重传后，A 收到了 B 的 ACK 消息，那么 A 与 B 之间的数据传输的延迟就达到 1 分钟以上。对于这样的延迟，实时互动的直播系统是根本无法接受的。

基于以上的原因，在实现**实时互动直播系统的时候你必须使用 UDP 协议**。

## 4、什么是HLS协议？其主要用途是什么？主要特点是什么？

 

# 二、 后端系统相关

## 1. Redis中如何实现数据访问的互斥？

## 2. 反向代理是什么概念？如何通过nginx配置一个反向代理？

## 3. 在搭建服务器集群的技术范畴内，什么是负载均衡？通常如何实现负载均衡,请描述实现服务器间负载均衡的各种方法和优缺点。

***\*简而言之，就是让自己编写的系统应用做到如何更优雅的”接客”。\****

***\*好，现在我们来看看，如何用正确的”姿势”来”接客”？\****

# ***\*设计思路\****

## ***\*设计层面需要考虑的Points\****

### ***\*Point1:静态页面设计\****

· cdn托管

· 网址隐藏

· 页面压缩

· 缓存机制

### ***\*Point2:动态页面设计\****

· 队列设置

· 乐观锁（利用redis原子操作实现）

· 异步调用

· 资质抢购

### ***\*Point3:高可用（双活）\****

***\*双活：\****让主备两个数据中心都同时承担用户的业务，此时，主备两个数据中心互为备份，并且进行实时备份，尤其是在缓存层和DB层。

### ***\*Point4:高并发（负载均衡，安全过滤）\****

***\*负载均衡：\****分软件层、硬件层、链路层，但不管哪一层，主要有两种通用常用技术思路：第一种是将大量的同时发送的数据流在多个节点上进行处理。第二种是将单一负载的大量分担在多个节点上进行并行处理，并且在所有节点都完成处理后将结果合并起来输出给用户。而现在，负载均衡技术已经不是什么新鲜技术，一般维护过服务器，或有两台以上的服务器都可以使用负载均衡技术。

***\*安全过滤：\****设置比较完备的rules过滤器。

### ***\*Point5: 数据库设计注意静态配置和动态数据分离\****

***\*静态配置：\****在前端页面主要呈现内容为主，在接口层主要只读的数据字段。

***\*动态数据：\****频繁更新，频繁检索的数据字段。

### ***\*Point6：缓存雪崩\****

注意设置缓存失效时间，不然超出redis缓存最大内存，溢出讲导致雪崩。

### ***\*Point7：缓存击穿\****

注意设置缓存失效时间的随机性，别同一时间同时失效，瞬间同时失效将导致密集的IO读写操作，容易导致缓存击穿。

### ***\*Point8:脱离原站点部署\****

***\*简而言之就是：千万不要把鸡蛋放在一个篮子里！！！\****

#### ***\*分业务分布式部署\****

**·** ***\*定义：\****一个业务分拆成多个子业务，部署在不同的服务器上。

**·** ***\*好处：\****强调机器间的协作，其重点是任务可拆分，如：某个任务需要一个机器运行10个小时， 将该该任务用10台机器的分布式跑，可能2个小时就跑完了。（子任务之间有依赖关系）。

**·** ***\*坏处：\****中心化带来的主要问题是可靠性，若中心节点宕机则整个系统不可用，分布式除了解决部分中心化问题，也倾向于分散负载，但分布式会带来很多的其他问题，最主要的就是一致性。

#### ***\*分容器分布式部署\****

**·** ***\*定义：\****俗称”集群”，同一个业务，部署在多个服务器容器上。为的

**·** ***\*好处：\****同一个业务部署在多台机器上，提高系统可用性。如：某个任务需要一个机器运行10个小时，那任务放到 处理该任务的集群上 还是需要10个小时。 假如有10个这样的任务， 放到同一个集群上， 仍然需要10个小时，但是由于挂载的机器来自不同地域节点，可以提升带宽上的物理传输速度，一台服务器垮了，其它的服务器可以顶上来。

**·** ***\*坏处：\****整体性能难得到显著得提升，受业务内极端需求峰值限制。

***\*PS： “没有最好的方式，只有最适合的方式”，不同的业务场景需求，不同的模块：数据库、缓存、消息中间件、媒体资源、系统应用等，需要选用不同的部署方案才能达到高可用，当然，一般更建议两种方式组合部署。\****

### ***\*Point9:监控+监控+监控（总要事情说三遍！）\****

系统研发完成，测试通过并不代表就结束了，一个高并发系统最关键的时期往往是在活动的峰值期间，为了不让RD们24小时目不转睛地盯着所有可能出现问题的地方，最好在关键处加上异常监控信息，以便及时对异常事件做出响应。

***\*这里介绍两个开源监控项目：\****